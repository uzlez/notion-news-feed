<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Defense Tech × Capital Signals</title>
  <style>
    :root { color-scheme: light; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #fff;
    }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { font-size: 16px; margin: 0 0 6px 0; font-weight: 700; letter-spacing: 0.1px; }
    .meta { font-size: 12px; opacity: 0.65; margin-bottom: 14px; }

    .section { margin: 18px 0 10px; padding-top: 6px; }
    .section-title {
      font-size: 13px;
      font-weight: 700;
      opacity: 0.85;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0 0 10px 0;
    }
    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.06);
      opacity: 0.9;
      font-weight: 600;
    }

    .item {
      padding: 12px 12px;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      margin-bottom: 10px;
    }
    .title {
      font-size: 14px;
      font-weight: 700;
      line-height: 1.28;
      margin: 0 0 6px 0;
    }
    .title a { color: inherit; text-decoration: none; }
    .title a:hover { text-decoration: underline; }

    .snippet {
      font-size: 12.5px;
      line-height: 1.35;
      margin: 0 0 8px 0;
      opacity: 0.82;
    }

    .sub {
      font-size: 11.5px;
      opacity: 0.72;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.05);
      font-weight: 600;
    }
    .err { color: #b00020; font-size: 13px; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Defense Tech × Capital Signals</h1>
    <div class="meta" id="status">Loading…</div>
    <div id="feed"></div>
    <div class="err" id="err"></div>
  </div>

<script>
  /***********************
   * CONFIG
   ***********************/
  const MAX_DAYS = 60;          // show only last N days
  const MAX_ITEMS = 15;         // show at most N items total

  // Two-bucket query (defense-tech terms) AND (capital/procurement/policy terms)
  const RSS_URL =
    "https://news.google.com/rss/search?q=" +
    encodeURIComponent(
      '("defense tech" OR "defence technology" OR "dual-use" OR "military AI" OR drones OR "autonomous systems" OR ISR OR "electronic warfare") ' +
      '(fund OR venture OR investment OR financing OR procurement OR contract OR "innovation fund" OR "industrial policy")'
    ) +
    "&hl=en-GB&gl=GB&ceid=GB:en";

  // Title-based noise filter: removes frontline/battlefield updates (keeps Ukraine as region)
  const NOISE_TERMS = [
    "frontline","front line","battlefield","shelling","missile","airstrike","strike hits",
    "killed","casualties","drone attack","russia hits","russian strike","ukraine hit",
    "map","battle","captured","territory","counteroffensive"
  ];

  /***********************
   * Helpers
   ***********************/
  const feedEl = document.getElementById("feed");
  const statusEl = document.getElementById("status");
  const errEl = document.getElementById("err");

  const MS_DAY = 24 * 60 * 60 * 1000;
  const cutoffMs = Date.now() - (MAX_DAYS * MS_DAY);

  function timeAgo(d) {
    const diff = Date.now() - d.getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ago`;
    const days = Math.floor(hrs / 24);
    return `${days}d ago`;
  }

  function stripHtml(html) {
    const div = document.createElement("div");
    div.innerHTML = html || "";
    return (div.textContent || div.innerText || "").replace(/\s+/g, " ").trim();
  }

  function truncate(s, n) {
    if (!s) return "";
    if (s.length <= n) return s;
    return s.slice(0, n).replace(/\s+\S*$/, "") + "…";
  }

  function extractSourceFromTitle(rawTitle) {
    // Google News often formats as: "Headline - Publisher"
    const parts = (rawTitle || "").split(" - ");
    if (parts.length >= 2) return parts[parts.length - 1].trim();
    return "Google News";
  }

  function extractHeadline(rawTitle) {
    const t = (rawTitle || "").trim();
    if (!t) return "";
    if (t.includes(" - ")) return t.split(" - ").slice(0, -1).join(" - ").trim();
    return t;
  }

  function isNoise(headline) {
    const h = (headline || "").toLowerCase();
    return NOISE_TERMS.some(term => h.includes(term));
  }

  // Auto-sectioning (title + snippet keywords)
  function classify(title, snippet) {
    const t = (title || "").toLowerCase();
    const s = (snippet || "").toLowerCase();
    const x = t + " " + s;

    const hasAny = (arr) => arr.some(k => x.includes(k));

    if (hasAny(["raises","raised","funding","seed","pre-seed","series a","series b","round","investment","invests","backed","valuation","vc","venture capital"])) {
      return "Funding / VC";
    }
    if (hasAny(["procurement","tender","contract","awarded","award","framework","supplier","purchase","order","deal signed","prime contractor"])) {
      return "Procurement / Contracts";
    }
    if (hasAny(["industrial policy","policy","regulation","sanctions","export controls","defence industrial","defense industrial","strategy","white paper","parliament","congress","commission","nato","eda","mod","pentagon"])) {
      return "Policy / Industrial";
    }
    if (hasAny(["drone","drones","autonomous","ai","military ai","isr","electronic warfare","ew","counter-uas","c-uas","sensor","radar","jammer","satellite","swarm","jetson"])) {
      return "Tech / Systems";
    }
    return "Other";
  }

  function sectionOrder(name) {
    const order = {
      "Funding / VC": 1,
      "Procurement / Contracts": 2,
      "Policy / Industrial": 3,
      "Tech / Systems": 4,
      "Other": 5
    };
    return order[name] || 99;
  }

  // ✅ UPDATED: more reliable multi-proxy fetch (fixes "Failed to fetch")
  async function fetchXmlText(url) {
    const proxies = [
      // AllOrigins JSON wrapper
      async (u) => {
        const p = "https://api.allorigins.win/get?url=" + encodeURIComponent(u);
        const r = await fetch(p, { cache: "no-store" });
        if (!r.ok) throw new Error("AllOrigins(get) HTTP " + r.status);
        const j = await r.json();
        if (!j || !j.contents) throw new Error("AllOrigins(get) empty contents");
        return j.contents;
      },
      // ThingProxy
      async (u) => {
        const p = "https://thingproxy.freeboard.io/fetch/" + u;
        const r = await fetch(p, { cache: "no-store" });
        if (!r.ok) throw new Error("ThingProxy HTTP " + r.status);
        return await r.text();
      },
      // corsproxy.io
      async (u) => {
        const p = "https://corsproxy.io/?" + encodeURIComponent(u);
        const r = await fetch(p, { cache: "no-store" });
        if (!r.ok) throw new Error("corsproxy.io HTTP " + r.status);
        return await r.text();
      }
    ];

    let lastErr = null;
    for (const fn of proxies) {
      try {
        const txt = await fn(url);
        if (txt && txt.length > 200) return txt;
        lastErr = new Error("Proxy returned too-short response");
      } catch (e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error("All proxies failed");
  }

  function renderSections(grouped) {
    const sectionNames = Object.keys(grouped).sort((a,b) => sectionOrder(a) - sectionOrder(b));
    const html = sectionNames.map(name => {
      const items = grouped[name];
      if (!items || !items.length) return "";
      return `
        <div class="section">
          <div class="section-title">
            ${name} <span class="badge">${items.length}</span>
          </div>
          ${items.map(renderItem).join("")}
        </div>
      `;
    }).join("");
    feedEl.innerHTML = html || `<div class="meta">No items matched your filters.</div>`;
  }

  function renderItem(obj) {
    const { headline, link, source, pubDate, snippet } = obj;
    return `
      <div class="item">
        <div class="title">
          <a href="${link}" target="_blank" rel="noopener noreferrer">${headline}</a>
        </div>
        ${snippet ? `<div class="snippet">${snippet}</div>` : ""}
        <div class="sub">
          <span class="pill">${source}</span>
          ${pubDate ? `<span class="pill">${timeAgo(pubDate)}</span>` : ""}
        </div>
      </div>
    `;
  }

  async function load() {
    try {
      errEl.textContent = "";
      const xmlText = await fetchXmlText(RSS_URL);

      const parser = new DOMParser();
      const xml = parser.parseFromString(xmlText, "text/xml");

      const rawItems = [...xml.querySelectorAll("item")];

      const parsed = rawItems.map(it => {
        const rawTitle = (it.querySelector("title")?.textContent || "").trim();
        const link = (it.querySelector("link")?.textContent || "").trim();
        const pubDateStr = (it.querySelector("pubDate")?.textContent || "").trim();
        const pubDate = pubDateStr ? new Date(pubDateStr) : null;

        const descHtml = (it.querySelector("description")?.textContent || "").trim();
        const descText = stripHtml(descHtml);

        const headline = extractHeadline(rawTitle);
        const source = extractSourceFromTitle(rawTitle);

        const snippet = truncate(descText, 200);

        return { headline, link, source, pubDate, snippet };
      });

      const filtered = parsed
        .filter(x => x.pubDate && x.pubDate.getTime() >= cutoffMs)
        .filter(x => !isNoise(x.headline))
        .sort((a, b) => b.pubDate.getTime() - a.pubDate.getTime())
        .slice(0, MAX_ITEMS);

      const grouped = {};
      for (const x of filtered) {
        const sec = classify(x.headline, x.snippet);
        if (!grouped[sec]) grouped[sec] = [];
        grouped[sec].push(x);
      }

      statusEl.textContent = `Last ${MAX_DAYS} days • showing ${filtered.length} items • refresh to update`;
      renderSections(grouped);

    } catch (e) {
      statusEl.textContent = "Couldn’t load feed.";
      errEl.textContent = String(e.message || e);
    }
  }

  load();
</script>
</body>
</html>
